
# User Story: Migrate Data Store to Firebase Firestore

As a developer, I want to migrate the application's data store from the current relational database using Entity Framework Core to Firebase Firestore, so that we can leverage a more scalable, real-time, and flexible NoSQL database.

## Acceptance Criteria

*   All data persistence logic currently using `DiaryDbContext` should be replaced with equivalent Firestore operations.
*   The application must be able to perform all existing CRUD (Create, Read, Update, Delete) operations for `DiaryEntry` and `Tag` entities using Firestore.
*   The many-to-many relationship between `DiaryEntry` and `Tag` must be preserved in the Firestore data model.
*   Data seeding and migration scripts should be created to move existing data from the current database to Firestore.
*   The application's configuration should be updated to use Firestore connection settings instead of the current database connection string.
*   All existing unit and integration tests must pass after the migration.
*   New integration tests should be written to specifically test the Firestore implementation.

## Technical Details and Considerations

### 1. Firestore Data Model

The existing relational models will be mapped to Firestore collections and documents.

*   **`diaryEntries` collection:**
    *   Each `DiaryEntry` will be a document in this collection.
    *   The document ID can be the existing `Id` (GUID).
    *   `Title`, `Content`, `CreatedAt`, `UpdatedAt`, `Mood`, `WordCount`, `Summary`, `Themes`, and `SentimentScore` will be fields in the document.
    *   The `Tags` property, which is a list of `Tag` objects, can be stored as an array of strings (tag names or IDs) or as an array of maps within the `DiaryEntry` document. Given the many-to-many relationship, storing an array of tag document references would be the most flexible approach.

*   **`tags` collection:**
    *   Each `Tag` will be a document in this collection.
    *   The document ID can be the existing `Id` or a new one generated by Firestore.
    *   `Name` and `Color` will be fields in the document.
    *   To maintain the many-to-many relationship, we will not store the `Entries` list in the `Tag` documents to avoid unbounded arrays. Instead, queries will be used on the `diaryEntries` collection to find all entries with a specific tag.

### 2. Implementation Changes

*   **`ThinkDiary.Data` project:**
    *   Remove `DiaryDbContext.cs` and all related Entity Framework Core configurations and migrations.
    *   Create a new `FirestoreService` or repository classes that will handle all interactions with Firestore.
    *   This service will use the `Google.Cloud.Firestore` NuGet package to connect to and interact with Firestore.

*   **`ThinkDiary.Core` project:**
    *   The `IDiaryService` interface will remain, but its implementation will be updated to use the new `FirestoreService`.
    *   The models (`DiaryEntry`, `Tag`, `Mood`) will likely need to be decorated with `FirestoreData` attributes for proper serialization/deserialization.

*   **Dependency Injection:**
    *   Update the dependency injection configuration to register the new `FirestoreService` and remove the `DbContext`.

### 3. Data Migration

*   A one-time migration script or utility should be created.
*   This script will:
    1.  Read all data from the existing database using the current `DbContext`.
    2.  Transform the data into the new Firestore data model.
    3.  Write the transformed data to Firestore.

### 4. Configuration

*   The `config.json` or other configuration files will need to be updated to include Firestore project details (e.g., `ProjectId`, `CredentialFile`).

## Out of Scope

*   This user story does not include any changes to the front-end client applications, other than what is necessary to support the backend changes.
*   Real-time data synchronization using Firestore's real-time listeners is not in the scope of this initial migration but can be a future enhancement.
